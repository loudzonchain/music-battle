<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard - Music Battle</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Matrix background layers -->
    <canvas class="matrix-rain" id="matrix-rain"></canvas>
    <div class="scan-lines"></div>

    <div class="window">
        <!-- Title bar with traffic lights -->
        <div class="title-bar">
            <button class="hamburger-btn" onclick="toggleMobileMenu()" aria-label="Menu">&#9776;</button>
            <div class="traffic-lights">
                <div class="traffic-light red"></div>
                <div class="traffic-light yellow"></div>
                <div class="traffic-light green"></div>
            </div>
            <div class="title-bar-text">Leaderboard</div>
        </div>

        <!-- Mobile slide-out menu -->
        <div class="mobile-menu-overlay" id="mobile-menu-overlay" onclick="toggleMobileMenu()"></div>
        <nav class="mobile-menu" id="mobile-menu">
            <div class="mobile-menu-header">
                <span>Menu</span>
                <button onclick="toggleMobileMenu()" aria-label="Close">&times;</button>
            </div>
            <div class="mobile-menu-section">
                <a href="index.html" class="mobile-menu-link">&#9876; Battle</a>
                <a href="leaderboard.html" class="mobile-menu-link active">&#9733; Rankings</a>
                <a href="playlist.html" class="mobile-menu-link">&#9835; My Playlist</a>
            </div>
            <div class="mobile-menu-divider"></div>
            <div class="mobile-menu-section">
                <span class="mobile-menu-link" onclick="loadLeaderboard(); toggleMobileMenu();">&#8634; Refresh Rankings</span>
            </div>
        </nav>

        <!-- Menu bar -->
        <div class="menu-bar">
            <div class="menu-item">
                File
                <div class="menu-dropdown">
                    <a href="index.html">Back to Battle</a>
                    <a href="playlist.html">My Playlist</a>
                    <div class="menu-divider"></div>
                    <span onclick="loadLeaderboard()">Refresh</span>
                </div>
            </div>
            <div class="menu-item">
                View
                <div class="menu-dropdown">
                    <span onclick="loadLeaderboard()">Refresh Rankings</span>
                </div>
            </div>
            <div class="menu-item">
                Help
                <div class="menu-dropdown">
                    <span>Top voted songs</span>
                    <div class="menu-divider"></div>
                    <span>v1.0</span>
                </div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <button class="toolbar-btn" onclick="window.location.href='index.html'">&#9876; Battle</button>
            <button class="toolbar-btn" onclick="loadLeaderboard()">&#8634; Refresh</button>
        </div>

        <!-- Window body -->
        <div class="window-body">
            <div class="leaderboard-container">
                <div class="leaderboard-header">
                    <a href="index.html" class="back-btn">&larr; Back to Battle</a>
                    <button onclick="loadLeaderboard()" class="back-btn">Refresh</button>
                </div>

                <div id="leaderboard-list">
                    <div class="loading">Loading...</div>
                </div>

                <div class="total-stats" id="total-stats">
                    <div class="big-number" id="total-battles">-</div>
                    <div class="label">Total Battles</div>
                </div>
            </div>
        </div>

        <!-- Status bar -->
        <div class="status-bar">
            <span>Music Battle Leaderboard</span>
            <a href="index.html">Back to Battle &rarr;</a>
        </div>
    </div>

    <script>
    function toggleMobileMenu() {
        document.getElementById('mobile-menu').classList.toggle('open');
        document.getElementById('mobile-menu-overlay').classList.toggle('open');
    }
    </script>

    <script>
        const API_URL = window.location.origin + '/api';

        async function loadLeaderboard() {
            try {
                const response = await fetch(`${API_URL}/leaderboard`);
                const songs = await response.json();

                const statsResponse = await fetch(`${API_URL}/stats`);
                const stats = await statsResponse.json();

                const container = document.getElementById('leaderboard-list');
                container.innerHTML = songs.map((song, index) => `
                    <div class="song-row">
                        <div class="rank rank-${index < 3 ? index + 1 : 'other'}">
                            ${index === 0 ? '<span class="crown">&#9733;</span>' : ''}#${song.rank}
                        </div>
                        <div class="song-details">
                            <h3>${song.title}</h3>
                            <p>${song.artist} <span class="genre-tag">${song.genre || ''}</span></p>
                        </div>
                        <div class="song-stats">
                            <div class="elo-rating">${song.global_elo}</div>
                            <div class="win-loss">${song.total_wins}W - ${song.total_battles - song.total_wins}L</div>
                        </div>
                        <div class="elo-delta ${song.elo_delta > 0 ? 'up' : song.elo_delta < 0 ? 'down' : 'neutral'}">
                            ${song.elo_delta > 0 ? '&#9650;' : song.elo_delta < 0 ? '&#9660;' : '&ndash;'} ${Math.abs(song.elo_delta)}
                        </div>
                    </div>
                `).join('');

                document.getElementById('total-battles').textContent = stats.totalBattles;

            } catch (error) {
                console.error('Failed to load leaderboard:', error);
                document.getElementById('leaderboard-list').innerHTML =
                    '<div class="loading">Failed to load. Is the server running?</div>';
            }
        }

        loadLeaderboard();
    </script>

    <!-- Matrix digital rain (fewer streams for readability) -->
    <script>
    (function() {
        const canvas = document.getElementById('matrix-rain');
        const ctx = canvas.getContext('2d');

        const chars = '\u266a\u266b\u266c\u26690011\u266a\u266b01\u266c10\u2669';
        const charArray = chars.split('');

        let streams = [];

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initStreams();
        }

        function initStreams() {
            const isMobile = window.innerWidth < 768;
            const streamCount = isMobile ? 5 : 8;  // Fewer streams for leaderboard
            streams = [];

            for (let i = 0; i < streamCount; i++) {
                streams.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height * -1,
                    speed: 0.3 + Math.random() * 0.5,
                    chars: [],
                    length: 8 + Math.floor(Math.random() * 12),
                    opacity: 0.06 + Math.random() * 0.08  // Slightly more subtle
                });

                for (let j = 0; j < streams[i].length; j++) {
                    streams[i].chars.push(charArray[Math.floor(Math.random() * charArray.length)]);
                }
            }
        }

        function draw() {
            ctx.fillStyle = 'rgba(10, 10, 10, 0.15)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.font = '14px "IBM Plex Mono", monospace';

            streams.forEach(function(stream) {
                for (let i = 0; i < stream.chars.length; i++) {
                    const y = stream.y + i * 22;

                    if (i === stream.chars.length - 1) {
                        ctx.fillStyle = 'rgba(0, 255, 159, ' + Math.min(stream.opacity * 2.5, 0.4) + ')';
                    } else {
                        const fade = 1 - (i / stream.chars.length);
                        ctx.fillStyle = 'rgba(0, 255, 159, ' + (stream.opacity * fade) + ')';
                    }

                    ctx.fillText(stream.chars[i], stream.x, y);

                    if (Math.random() < 0.02) {
                        stream.chars[i] = charArray[Math.floor(Math.random() * charArray.length)];
                    }
                }

                stream.y += stream.speed;

                if (stream.y > canvas.height + 100) {
                    stream.y = -stream.length * 22;
                    stream.x = Math.random() * canvas.width;
                    stream.speed = 0.3 + Math.random() * 0.5;
                }
            });

            requestAnimationFrame(draw);
        }

        const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)');
        if (!prefersReduced.matches) {
            resize();
            window.addEventListener('resize', resize);
            draw();
        }
    })();
    </script>
</body>
</html>
